# Listener 앱 - 제품 명세서

> Android 언어 학습 앱 - 팟캐스트/오디오 파일을 전사하여 chunk 단위 반복 학습

---

## 1. 제품 개요

### 1.1 목표 UX

1. 팟캐스트 에피소드 또는 기기 오디오 파일 선택
2. 재생 전 전사 완료 (OpenAI Whisper API)
3. 전사 결과를 문장부호 기준으로 chunk 분절
4. 학습 재생: `[원문 재생] → [무음 공백] → 다음 chunk` 반복
5. 전사/분절/진행 상태 저장 (재전사 방지)
6. 공백 구간 사용자 발화 녹음 저장

### 1.2 기술 스택

| 항목 | 기술 |
|------|------|
| 언어 | Kotlin |
| UI | Jetpack Compose |
| 미디어 | Media3 (ExoPlayer) |
| 백그라운드 재생 | MediaSessionService |
| 로컬 DB | Room |
| 전사 API | OpenAI Transcriptions API |
| 팟캐스트 검색 | iTunes Search API |
| DI | Hilt |

### 1.3 확정된 설정값

| 항목 | 값 |
|------|-----|
| 오디오 캐시 최대 용량 | 1GB (초과 시 오래된 것부터 삭제) |
| 녹음 형식 | AAC 64kbps / 22kHz / Mono |
| 최소 chunk 길이 | 1.2초 (minChunkMs = 1200) |
| 기본 반복 횟수 | 2회 |
| 기본 공백 비율 | 0.4x |

---

## 2. 앱 구조

### 2.1 네비게이션

```
┌─────────────────────────────────────────────────────────┐
│                    메인 콘텐츠 영역                      │
├─────────────────────────────────────────────────────────┤
│  🎙️ EP.289 How to Sound...   ⏪  ⏯️  ⏩  ▓▓▓░░░       │  ← 미니 플레이어
│     영어 회화 연습 | All Ears English                   │
├─────────────────────────────────────────────────────────┤
│   🏠      📋      🎙️      📁      ⚙️                   │
│   홈    플레이    팟캐     미디어   설정                  │
│         리스트    스트     파일                          │
└─────────────────────────────────────────────────────────┘
```

### 2.2 화면 목록

| 화면 | 설명 |
|------|------|
| 홈 | 이어서 학습하기 + 새 에피소드 |
| 플레이리스트 | 플레이리스트 목록/상세 |
| 팟캐스트 | 구독 목록, 검색, 에피소드 목록 |
| 미디어 파일 | 로컬 오디오 파일 목록 |
| 설정 | 학습/전사/저장공간/API 설정 |
| 전사 진행 | 다운로드 + 전사 진행 표시 |
| 전체 화면 플레이어 | 학습 재생 메인 화면 |
| 미니 플레이어 | 하단 탭 위 고정 재생 컨트롤 |

---

## 3. 화면별 상세 명세

### 3.1 홈 탭

```
┌─────────────────────────────────────┐
│  Listener                           │
├─────────────────────────────────────┤
│                                     │
│  ▶️ 이어서 학습하기                   │
│  ───────────────────────────────── │
│  ┌───────────────────────────────┐  │
│  │ 🎙️ EP.289 How to Sound Natural│  │
│  │   All Ears English · 80%      │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │ 📁 interview_recording.mp3    │  │
│  │   미디어 파일 · 30%            │  │
│  └───────────────────────────────┘  │
│                     더보기 ▶        │
│                                     │
│  ───────────────────────────────── │
│                                     │
│  📬 새 에피소드                      │
│  ───────────────────────────────── │
│  ┌───────────────────────────────┐  │
│  │ 🔴 EP.290 Advanced Tips        │  │
│  │    All Ears English · 18분    │  │
│  └───────────────────────────────┘  │
│                                     │
│         ─ 구독 없을 때 ─            │
│      🎙️                             │
│      팟캐스트 탭에서                 │
│      구독을 시작해보세요             │
│      [ 🎙️ 팟캐스트 탭으로 ]          │
│                                     │
├─────────────────────────────────────┤
│   🏠      📋      🎙️      📁      ⚙️ │
└─────────────────────────────────────┘
```

#### 기능 명세

| 섹션 | 기능 | 명세 |
|------|------|------|
| 이어서 학습하기 | 최근 학습 목록 | `lastAccessedAt DESC`, 최대 5개 |
| | 항목 탭 | 전체 화면 플레이어로 이동 |
| | 더보기 | 전체 학습 기록 화면 |
| 새 에피소드 | 구독 팟캐스트 새 에피소드 | `pubDate DESC`, 최대 10개 |
| | 항목 탭 | 에피소드 상세 바텀시트 |
| | 빈 상태 | 팟캐스트 탭으로 유도 버튼 |

---

### 3.2 플레이리스트 탭

```
┌─────────────────────────────────────┐
│  플레이리스트                   ＋   │
├─────────────────────────────────────┤
│  ┌─────────────────────────────────┐│
│  │ 📋 영어 회화 연습                ││
│  │    12개 항목 · 4시간 32분        ││
│  │    ████████░░ 67%               ││
│  └─────────────────────────────────┘│
│                                     │
│  ┌─────────────────────────────────┐│
│  │ 📋 비즈니스 영어                 ││
│  │    8개 항목 · 2시간 15분         ││
│  │    ██░░░░░░░░ 20%               ││
│  └─────────────────────────────────┘│
├─────────────────────────────────────┤
│   🏠      📋      🎙️      📁      ⚙️ │
└─────────────────────────────────────┘
```

#### 플레이리스트 상세

```
┌─────────────────────────────────────┐
│  ◀  영어 회화 연습            ⋮     │
├─────────────────────────────────────┤
│  12개 항목 · 4시간 32분              │
│  ████████░░ 67% 완료                │
│       [ ▶️ 이어서 학습 ]             │
├─────────────────────────────────────┤
│  ☰  1. ✅ EP.285 Basic Greetings    │
│         All Ears English · 18분     │
│                                     │
│  ☰  2. ✅ EP.286 Small Talk         │
│         All Ears English · 22분     │
│                                     │
│  ☰  3. ▶️ EP.287 Asking Questions   │  ← 현재 진행 중
│         All Ears English · 20분     │
│         ████░░░░░░ 40%              │
│                                     │
│  ☰  4. ⬜ EP.288 Business English   │
│         All Ears English · 25분     │
├─────────────────────────────────────┤
│   🏠      📋      🎙️      📁      ⚙️ │
└─────────────────────────────────────┘
```

#### 기능 명세

| 화면 | 기능 | 명세 |
|------|------|------|
| 플레이리스트 목록 | ＋ 버튼 | 새 플레이리스트 생성 다이얼로그 |
| | 항목 탭 | 상세 화면 |
| | 항목 롱프레스 | 편집/삭제 메뉴 |
| 상세 | ☰ 드래그 | 순서 변경 |
| | 이어서 학습 | 첫 번째 미완료 항목부터 재생 |
| | 항목 탭 | 해당 항목 학습 시작 |
| | ⋮ 메뉴 | 항목 추가, 이름 편집, 삭제 |

---

### 3.3 팟캐스트 탭

```
┌─────────────────────────────────────┐
│  팟캐스트                       🔍   │
├─────────────────────────────────────┤
│  구독 중 (3)                         │
│  ───────────────────────────────── │
│  ┌──────────┐ ┌──────────┐         │
│  │  🎙️      │ │  🎙️      │         │
│  │ All Ears │ │ 6 Minute │         │
│  │ English  │ │ English  │         │
│  │ 289개    │ │ 156개    │         │
│  │ 🔴 3      │ │          │         │
│  └──────────┘ └──────────┘         │
│                                     │
│         ─ 구독 없을 때 ─            │
│  추천 팟캐스트                       │
│  ┌───────────────────────────────┐  │
│  │ 🎙️ All Ears English           │  │
│  │   ⭐ 4.8 · 영어 회화            │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │ 🎙️ 6 Minute English           │  │
│  │   ⭐ 4.7 · BBC 영어            │  │
│  └───────────────────────────────┘  │
├─────────────────────────────────────┤
│   🏠      📋      🎙️      📁      ⚙️ │
└─────────────────────────────────────┘
```

#### 팟캐스트 검색

```
┌─────────────────────────────────────┐
│  ◀  팟캐스트 검색                    │
├─────────────────────────────────────┤
│  ┌─────────────────────────────────┐│
│  │ 🔍 english learning         ✕  ││
│  └─────────────────────────────────┘│
├─────────────────────────────────────┤
│  ┌─────┬───────────────────────┐   │
│  │ 🎙️  │ All Ears English       │   │
│  │     │ ⭐ 4.8 · 교육          │   │
│  │     │ ✅ 구독 중              │   │
│  └─────┴───────────────────────┘   │
│  ┌─────┬───────────────────────┐   │
│  │ 🎙️  │ 6 Minute English      │   │
│  │     │ ⭐ 4.7 · BBC          │   │
│  │     │ [ ＋ 구독 ]            │   │
│  └─────┴───────────────────────┘   │
├─────────────────────────────────────┤
│   🏠      📋      🎙️      📁      ⚙️ │
└─────────────────────────────────────┘
```

#### 에피소드 바텀시트

```
┌─────────────────────────────────────┐
│  ━━━━━━━━━━━                        │
│  EP.289 How to Sound Natural        │
│  All Ears English                   │
│  25분 · 2024.01.15                  │
│  ─────────────────────────────────  │
│  So in today's episode, we're       │
│  going to talk about how native     │
│  speakers actually sound...         │
│  ─────────────────────────────────  │
│  ┌─────────────────────────────────┐│
│  │      ▶️  학습 시작               ││
│  └─────────────────────────────────┘│
│  ┌─────────────────────────────────┐│
│  │      📋  플레이리스트에 추가     ││
│  └─────────────────────────────────┘│
└─────────────────────────────────────┘
```

#### 기능 명세

| 화면 | 기능 | 명세 |
|------|------|------|
| 팟캐스트 목록 | 🔍 버튼 | 검색 화면 |
| | 항목 탭 | 에피소드 목록 |
| | 🔴 배지 | 새 에피소드 수 |
| | 빈 상태 | 추천 팟캐스트 표시 |
| 검색 | 검색 입력 | 300ms debounce, iTunes API |
| | 결과 항목 탭 | 에피소드 목록 |
| 바텀시트 | 학습 시작 | 전사 진행 → 전체 화면 플레이어 |
| | 플레이리스트에 추가 | 플레이리스트 선택 다이얼로그 |

---

### 3.4 미디어 파일 탭

```
┌─────────────────────────────────────┐
│  미디어 파일                    ＋   │
├─────────────────────────────────────┤
│  3개 파일 · 1시간 25분               │
│  ───────────────────────────────── │
│  ┌─────────────────────────────────┐│
│  │ 📁 interview_recording.mp3      ││
│  │    45분 · 2024.01.10 추가       ││
│  │    ✅ 전사완료 · ███░░░░ 30%    ││
│  └─────────────────────────────────┘│
│  ┌─────────────────────────────────┐│
│  │ 📁 lecture_part1.m4a            ││
│  │    28분 · 2024.01.08 추가       ││
│  │    ✅ 전사완료 · ░░░░░░ 0%      ││
│  └─────────────────────────────────┘│
│                                     │
│         ─ 빈 상태 ─                 │
│      📁                             │
│      기기의 오디오 파일을            │
│      추가해서 학습하세요             │
│      [ ＋ 파일 추가 ]               │
├─────────────────────────────────────┤
│   🏠      📋      🎙️      📁      ⚙️ │
└─────────────────────────────────────┘
```

#### 기능 명세

| 기능 | 명세 |
|------|------|
| ＋ 버튼 | 파일 피커 (`ACTION_OPEN_DOCUMENT`, `audio/*`) |
| 항목 탭 | 바텀시트 (에피소드와 동일) |
| 항목 롱프레스 | 삭제 메뉴 |

---

### 3.5 설정 탭

```
┌─────────────────────────────────────┐
│  설정                               │
├─────────────────────────────────────┤
│  학습                               │
│  ───────────────────────────────── │
│  │ 기본 반복 횟수              2회 ▶│
│  │ 기본 공백 비율            0.4x ▶│
│  │ 자동 녹음                   ON 🔘│
│                                     │
│  전사                               │
│  ───────────────────────────────── │
│  │ 전사 언어               English ▶│
│  │ 최소 구간 길이            1.2초 ▶│
│  │ 문장 단위로만 자르기        ON 🔘│
│                                     │
│  저장 공간                           │
│  ───────────────────────────────── │
│  │ 오디오 캐시          847MB/1GB ▶│
│  │ 녹음 파일               124MB ▶ │
│  │ 캐시 전체 삭제                  ▶│
│                                     │
│  API                                │
│  ───────────────────────────────── │
│  │ OpenAI API 키           설정됨 ▶│
│                                     │
│  정보                               │
│  ───────────────────────────────── │
│  │ 버전                    1.0.0   │
├─────────────────────────────────────┤
│   🏠      📋      🎙️      📁      ⚙️ │
└─────────────────────────────────────┘
```

#### 기능 명세

| 섹션 | 항목 | 명세 |
|------|------|------|
| 학습 | 기본 반복 횟수 | 1~5, 기본값 2 |
| | 기본 공백 비율 | 0.2/0.4/0.6/0.8/1.0, 기본값 0.4 |
| | 자동 녹음 | ON/OFF, 기본값 ON |
| 전사 | 전사 언어 | 언어 선택 (en, ko, ja, zh 등) |
| | 최소 구간 길이 | 0.5~3.0초, 기본값 1.2초 |
| | 문장 단위로만 자르기 | ON: `. ! ?`만 / OFF: `, . ! ?` 포함, 기본값 ON |
| 저장 공간 | 오디오 캐시 | 탭 → 상세 목록, 최대 1GB |
| | 녹음 파일 | 탭 → 상세 목록 |
| | 캐시 전체 삭제 | 확인 다이얼로그 |
| API | OpenAI API 키 | 입력/수정 다이얼로그 |

---

### 3.6 전사 진행 화면

```
┌─────────────────────────────────────┐
│  ◀  EP.289 How to Sound Natural     │
├─────────────────────────────────────┤
│                                     │
│           ┌───────────┐             │
│           │    🎙️     │             │
│           └───────────┘             │
│                                     │
│      How to Sound Natural           │
│      25분 · All Ears English        │
│                                     │
│  ─────────────────────────────────  │
│    ⬇️ 다운로드 중...                 │
│    ████████████░░░░░░░░ 60%         │
│  ─────────────────────────────────  │
│    📝 전사 대기 중                   │
│    ░░░░░░░░░░░░░░░░░░░░             │
│                                     │
│         [ 취소 ]                    │
├─────────────────────────────────────┤
│   🏠      📋      🎙️      📁      ⚙️ │
└─────────────────────────────────────┘
```

#### 전사 완료 상태

```
│    ✅ 전사 완료!                     │
│    ████████████████████ 100%        │
│                                     │
│    87개 학습 구간 생성됨             │
│                                     │
│       [ ▶️ 학습 시작 ]               │
```

#### 기능 명세

| 단계 | 동작 | 상세 |
|------|------|------|
| 1. 다운로드 | 오디오 캐시 | Media3 DownloadManager |
| 2. 전사 | OpenAI API | `verbose_json`, `segment+word` |
| 3. 분절 | chunk 생성 | 문장부호 기반 + minChunkMs 병합 |
| 4. 저장 | DB 저장 | 전사 결과, chunk 목록, 진행 상태 |
| 취소 | 작업 중단 | 부분 데이터 삭제 |

---

### 3.7 미니 플레이어

```
┌─────────────────────────────────────────────────────────┐
│  🎙️ EP.289 How to Sound Nat...   ⏪  ⏯️  ⏩  ▓▓▓░░░   │
│     영어 회화 연습 | All Ears English                   │
└─────────────────────────────────────────────────────────┘
```

#### 서브타이틀 규칙

| 상황 | 표시 |
|------|------|
| 플레이리스트 + 팟캐스트 | `플레이리스트명 \| 팟캐스트명` |
| 플레이리스트 + 로컬파일 | `플레이리스트명 \| 미디어 파일` |
| 단독 + 팟캐스트 | `팟캐스트명` |
| 단독 + 로컬파일 | `미디어 파일` |

#### 기능 명세

| 요소 | 동작 |
|------|------|
| ⏪ | 이전 chunk |
| ⏯️ | 재생/일시정지 |
| ⏩ | 다음 chunk |
| 진행 바 | 현재 chunk 내 진행률 (표시만) |
| 타이틀 탭 | 전체 화면 플레이어 확장 |
| 위로 스와이프 | 전체 화면 플레이어 확장 |

---

### 3.8 전체 화면 플레이어

#### 기본 모드 (전사문 표시)

```
┌─────────────────────────────────────┐
│  ▼  EP.289 How to Sound Natural     │  ← 헤더: 아래 스와이프로 축소
│     영어 회화 연습 | All Ears English│
├─────────────────────────────────────┤
│     12 / 87              🙈  ⋮      │
├─────────────────────────────────────┤
│                                     │
│  │ So the first thing you need     │
│  │ to understand is that native    │
│  │ speakers don't always speak     │
│  │ perfectly,                   🔊  │  ← 녹음 있으면 🔊
│  │                                  │
│  ┃ and that's actually a good      │  ← 현재 chunk
│  ┃ thing to know.               🔊  │
│  │                                  │
│  │ Because when you realize this,  │
│  │ you can relax a little bit      │
│  │ more.                           │  ← 녹음 없으면 숨김
│                                     │
├─────────────────────────────────────┤
│         상태:  PLAY                  │
│    ▓▓▓▓▓▓▓▓▓▓▓▓░░░░ 2.1s           │
├─────────────────────────────────────┤
│  ⏮️      ⏪      ⏯️      ⏩      ⏭️   │
│  이전    이전    재생    다음    다음  │
│  항목   chunk          chunk   항목  │
├─────────────────────────────────────┤
│   🔁      📊      🎤      ⚡        │
│  반복x2  공백0.4  녹음ON  일반       │
└─────────────────────────────────────┘
```

#### 가림 모드 (🙈 → 👁️)

```
├─────────────────────────────────────┤
│     12 / 87              👁️  ⋮      │
├─────────────────────────────────────┤
│                                     │
│  │ 1:15 ~ 1:19           🔊   👁️   │
│  │                                  │
│  │ 1:19 ~ 1:23           🔊   👁️   │
│  │                                  │
│  ┃ 1:23 ~ 1:28           🔊   👁️   │  ← 현재 chunk
│  │                                  │
│  │ 1:28 ~ 1:32                👁️   │  ← 녹음 없으면 🔊 숨김
│  │                                  │
│  │ 1:32 ~ 1:38                👁️   │
│                                     │
├─────────────────────────────────────┤
```

#### 가림 모드 - chunk 열린 상태

```
│  │ 1:19 ~ 1:23           🔊   👁️   │
│  │                                  │
│  ┃ 1:23 ~ 1:28           🔊   👁️   │
│  ┃ and that's actually a good      │  ← 👁️ 탭해서 열림
│  ┃ thing to know.                   │
│  │                                  │
│  │ 1:28 ~ 1:32                👁️   │
```

#### 단독 재생 시 (플레이리스트 없음)

```
├─────────────────────────────────────┤
│  ⏮️      ⏪      ⏯️      ⏩      ⏭️   │
│  ━━      이전    재생    다음    ━━  │  ← ⏮️ ⏭️ 비활성화 (회색)
│         chunk          chunk        │
├─────────────────────────────────────┤
```

#### HARD 모드

```
├─────────────────────────────────────┤
│   🔁      📊      🎤      ⚡        │
│  반복x2  공백0.4  녹음ON  HARD      │
│                   (회색)            │  ← 녹음 강제 ON, 탭 불가
└─────────────────────────────────────┘
```

#### 기능 명세

| 영역 | 요소 | 동작 |
|------|------|------|
| 헤더 | ▼ / 아래 스와이프 | 미니 플레이어로 축소 |
| 전사문 | 위아래 스와이프 | 스크롤 |
| | 좌로 스와이프 | 다음 chunk |
| | 우로 스와이프 | 이전 chunk |
| | chunk 탭 | 해당 chunk로 이동 |
| | 🔊 탭 | 해당 chunk 녹음 재생 |
| 🙈/👁️ | 탭 | 가림 모드 토글 |
| 가림 모드 | 👁️ 탭 | 해당 chunk만 열림/닫힘 |
| | 자동 닫힘 | 다음 chunk 이동 시 이전 것 닫힘 |
| 5버튼 | ⏮️ | 플레이리스트 이전 항목 (없으면 비활성화) |
| | ⏪ | 이전 chunk |
| | ⏯️ | 재생/일시정지 |
| | ⏩ | 다음 chunk |
| | ⏭️ | 플레이리스트 다음 항목 (없으면 비활성화) |
| 하단 아이콘 | 🔁 탭 | 반복: 1→2→3→4→5→1 순환 |
| | 📊 탭 | 공백: 0.2→0.4→0.6→0.8→1.0→0.2 순환 |
| | 🎤 탭 | 녹음 ON/OFF (HARD 모드에서 비활성화) |
| | ⚡ 탭 | 일반 ↔ HARD 모드 토글 |
| ⋮ 메뉴 | | 녹음 목록, 플레이리스트 추가/제거 |

---

## 4. 학습 모드

### 4.1 일반 모드

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│   ┌──────┐   play()   ┌──────┐                         │
│   │ IDLE │ ─────────▶ │ PLAY │  원문 재생              │
│   └──────┘            └──────┘                         │
│       ▲                   │                            │
│       │                   │ 재생 완료                   │
│       │                   ▼                            │
│       │              ┌──────┐                          │
│       │              │ GAP  │  공백 (녹음 ON이면 녹음)  │
│       │              └──────┘                          │
│       │                   │                            │
│       │                   │ 공백 완료                   │
│       │                   ▼                            │
│       │         ┌─────────────────┐                    │
│       │         │ 반복 남았나?     │                    │
│       │         └─────────────────┘                    │
│       │            │YES      │NO                       │
│       │            ▼         ▼                         │
│       │         PLAY로    다음 chunk                   │
│       └─────────────────────────────────────────────── │
└─────────────────────────────────────────────────────────┘
```

**패턴:** `[원문] → [공백(+녹음)] × 반복횟수`

### 4.2 HARD 모드

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│   ┌──────┐   play()   ┌────────┐                       │
│   │ IDLE │ ─────────▶ │ PLAY_1 │  1차 원문 재생        │
│   └──────┘            └────────┘                       │
│       ▲                   │                            │
│       │                   │ 재생 완료                   │
│       │                   ▼                            │
│       │              ┌────────┐                        │
│       │              │  GAP   │  공백 + 녹음           │
│       │              │ + REC  │  (여기서 녹음!)        │
│       │              └────────┘                        │
│       │                   │                            │
│       │                   │ 공백 완료, 녹음 저장        │
│       │                   ▼                            │
│       │              ┌────────┐                        │
│       │              │ PLAY_2 │  2차 원문 재생         │
│       │              │        │  (녹음 없음)           │
│       │              └────────┘                        │
│       │                   │                            │
│       │                   │ 재생 완료                   │
│       │                   ▼                            │
│       │              ┌────────┐                        │
│       │              │PLAYBACK│  방금 녹음 재생        │
│       │              │  REC   │  (자기 발음 비교)      │
│       │              └────────┘                        │
│       │                   │                            │
│       │                   │ 재생 완료                   │
│       │                   ▼                            │
│       │         ┌─────────────────┐                    │
│       │         │ 반복 남았나?     │                    │
│       │         └─────────────────┘                    │
│       │            │YES      │NO                       │
│       │            ▼         ▼                         │
│       │        PLAY_1로   다음 chunk                   │
│       └─────────────────────────────────────────────── │
└─────────────────────────────────────────────────────────┘
```

**패턴:** `[1차 원문] → [공백+녹음] → [2차 원문] → [내 녹음 재생] × 반복횟수`

**학습 흐름:**
1. **PLAY_1**: 원문 듣기
2. **GAP+REC**: 따라 말하기 (녹음됨)
3. **PLAY_2**: 원문 다시 듣기 (비교 준비)
4. **PLAYBACK_REC**: 내 녹음 듣기 (원문과 비교)

### 4.3 모드 비교

| 항목 | 일반 모드 | HARD 모드 |
|------|-----------|-----------|
| 패턴 | 원문 → 공백 | 원문 → 공백+녹음 → 원문 → 내녹음 |
| 녹음 | 선택 (ON/OFF) | 강제 ON |
| 🎤 아이콘 | 탭 가능 | 회색, 탭 불가 |
| 목적 | 듣고 따라하기 | 원문과 내 발음 비교 |

---

## 5. 제스처 요약

| 위치 | 제스처 | 동작 |
|------|--------|------|
| 미니 플레이어 | 위로 스와이프 | 전체 화면 확장 |
| | 타이틀 탭 | 전체 화면 확장 |
| 전체 화면 - 헤더 | 아래로 스와이프 | 미니 플레이어로 축소 |
| 전체 화면 - 전사문 | 위아래 스와이프 | 스크롤 |
| | 좌로 스와이프 | 다음 chunk |
| | 우로 스와이프 | 이전 chunk |
| | chunk 탭 | 해당 chunk로 이동 |

---

## 6. 데이터 모델

### 6.1 구독 팟캐스트

| 필드 | 타입 | 설명 |
|------|------|------|
| feedUrl | String (PK) | RSS Feed URL |
| collectionId | Long? | iTunes ID |
| title | String | 팟캐스트 이름 |
| artworkUrl | String? | 아트워크 이미지 URL |
| lastCheckedAt | Long | 마지막 새 에피소드 확인 시간 |
| addedAt | Long | 구독 추가 시간 |

### 6.2 팟캐스트 에피소드

| 필드 | 타입 | 설명 |
|------|------|------|
| id | String (PK) | guid 또는 audioUrl 해시 |
| feedUrl | String (FK) | 소속 팟캐스트 |
| title | String | 에피소드 제목 |
| audioUrl | String | 오디오 파일 URL |
| description | String? | 설명 |
| durationMs | Long? | 재생 시간 |
| pubDate | Long | 발행일 |
| isNew | Boolean | 새 에피소드 여부 |

### 6.3 로컬 오디오 파일

| 필드 | 타입 | 설명 |
|------|------|------|
| contentHash | String (PK) | 파일 SHA-256 해시 |
| uri | String | Content URI |
| displayName | String | 파일명 |
| durationMs | Long? | 재생 시간 |
| addedAt | Long | 추가 시간 |

### 6.4 전사 결과

| 필드 | 타입 | 설명 |
|------|------|------|
| sourceId | String (PK) | 콘텐츠 ID (에피소드 ID 또는 contentHash) |
| language | String | 전사 언어 |
| fullText | String | 전체 전사 텍스트 |
| segmentsJson | String | segment 목록 JSON |
| wordsJson | String | word 목록 JSON |
| createdAt | Long | 전사 시간 |

### 6.5 학습 Chunk

| 필드 | 타입 | 설명 |
|------|------|------|
| id | Long (PK) | 자동 생성 |
| sourceId | String (FK) | 콘텐츠 ID |
| orderIndex | Int | 순서 (0부터) |
| startMs | Long | 시작 시간 (밀리초) |
| endMs | Long | 종료 시간 (밀리초) |
| displayText | String | 표시 텍스트 |

### 6.6 학습 진행 상태

| 필드 | 타입 | 설명 |
|------|------|------|
| sourceId | String (PK) | 콘텐츠 ID |
| currentChunkIndex | Int | 현재 chunk 인덱스 |
| repeatCount | Int | 반복 횟수 설정 |
| gapRatio | Float | 공백 비율 설정 |
| isRecordingEnabled | Boolean | 녹음 ON/OFF |
| isHardMode | Boolean | HARD 모드 여부 |
| updatedAt | Long | 마지막 학습 시간 |

### 6.7 사용자 녹음

| 필드 | 타입 | 설명 |
|------|------|------|
| sourceId | String (PK1) | 콘텐츠 ID |
| chunkIndex | Int (PK2) | chunk 인덱스 |
| filePath | String | 녹음 파일 경로 |
| durationMs | Long | 녹음 길이 |
| updatedAt | Long | 마지막 녹음 시간 |

**녹음 규칙:** chunk당 1개만 저장, 새 녹음 시 덮어쓰기

### 6.8 플레이리스트

| 필드 | 타입 | 설명 |
|------|------|------|
| id | Long (PK) | 자동 생성 |
| name | String | 플레이리스트 이름 |
| createdAt | Long | 생성 시간 |
| updatedAt | Long | 수정 시간 |

### 6.9 플레이리스트 항목

| 필드 | 타입 | 설명 |
|------|------|------|
| id | Long (PK) | 자동 생성 |
| playlistId | Long (FK) | 소속 플레이리스트 |
| sourceId | String | 콘텐츠 ID |
| sourceType | Enum | PODCAST_EPISODE / LOCAL_FILE |
| orderIndex | Int | 순서 |
| addedAt | Long | 추가 시간 |

### 6.10 최근 학습

| 필드 | 타입 | 설명 |
|------|------|------|
| sourceId | String (PK) | 콘텐츠 ID |
| sourceType | Enum | PODCAST_EPISODE / LOCAL_FILE |
| title | String | 제목 |
| subtitle | String | 출처 이름 |
| currentChunkIndex | Int | 현재 chunk |
| totalChunks | Int | 전체 chunk 수 |
| thumbnailUrl | String? | 썸네일 |
| lastAccessedAt | Long | 마지막 접근 시간 |

---

## 7. API 명세

### 7.1 iTunes Search API

**팟캐스트 검색**

```
GET https://itunes.apple.com/search
  ?term={query}
  &media=podcast
  &limit=20
  &offset={offset}
```

**응답 필드:**
- `collectionId`: iTunes ID
- `collectionName`: 팟캐스트 이름
- `artworkUrl100`: 아트워크 URL
- `feedUrl`: RSS Feed URL
- `primaryGenreName`: 장르

### 7.2 OpenAI Transcriptions API

**전사 요청**

```
POST https://api.openai.com/v1/audio/transcriptions
Content-Type: multipart/form-data

file: <audio_file>
model: whisper-1
response_format: verbose_json
timestamp_granularities[]: segment
timestamp_granularities[]: word
language: {설정된 언어}
```

**응답 구조:**
```json
{
  "text": "전체 텍스트",
  "segments": [
    {
      "start": 0.0,
      "end": 2.5,
      "text": "segment 텍스트"
    }
  ],
  "words": [
    {
      "word": "단어",
      "start": 0.0,
      "end": 0.3
    }
  ]
}
```

---

## 8. 분절 알고리즘 (ankigpt 방식)

### 8.1 개요

Whisper API 응답의 `segment`(텍스트)와 `words`(타임스탬프)를 조합하여 정확한 chunk를 생성합니다.

```
┌─────────────────────────────────────────────────────────────────┐
│  Whisper API 응답                                               │
│  ├─ segments: 구두점 포함된 텍스트 블록                          │
│  └─ words: 각 단어별 (start, end) 타임스탬프                     │
│                        ↓                                        │
│  1. segment_text를 단어로 분리                                   │
│  2. 구두점으로 끝나는 단어 위치 = 문장 경계                       │
│  3. 각 문장의 마지막 3개 단어를 words에서 시퀀스 매칭             │
│  4. 매칭된 word의 타임스탬프로 chunk 생성                        │
│  5. minChunkMs 미만이면 다음 chunk와 병합                        │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2 구분자 설정

| 설정 | 구분자 | 용도 |
|------|--------|------|
| 문장 단위로만 자르기 ON (기본) | `. ! ?` | 완전한 문장 단위. 긴 chunk |
| 문장 단위로만 자르기 OFF | `, . ! ?` | 구절 단위. 짧은 chunk |

### 8.3 시퀀스 매칭 알고리즘

```
function splitByPunctuation(segmentText, words, sentenceOnly):
    // 1. 구분자 결정
    if sentenceOnly:
        delimiters = ['.', '!', '?']
    else:
        delimiters = [',', '.', '!', '?']

    // 2. segment_text를 단어로 분리
    segmentWords = segmentText.split()

    // 3. 구두점으로 끝나는 단어 위치 찾기 (문장 경계)
    sentenceEndIndices = []
    for i, word in enumerate(segmentWords):
        if word.endsWith(any of delimiters):
            sentenceEndIndices.append(i)

    // 4. 각 문장에 대해 타임스탬프 매칭
    sentences = []
    wordIdx = 0
    prevEndIdx = -1

    for endIdx in sentenceEndIndices:
        sentText = join(segmentWords[prevEndIdx+1 : endIdx+1])
        sentWords = sentText.split()

        sentStart = words[wordIdx].start

        // 마지막 3개 단어로 시퀀스 매칭 (하이픈 확장 포함)
        foundEndIdx = null
        for nWords in [3, 2, 1]:
            if len(sentWords) >= nWords:
                tailWords = sentWords[-nWords:]
                pattern = expandHyphenated(tailWords)  // "mind-blowing" → ["mind", "blowing"]

                foundEndIdx = findSequence(pattern, wordIdx, words)
                if foundEndIdx != null:
                    break

        if foundEndIdx != null:
            sentEnd = words[foundEndIdx].end
            wordIdx = foundEndIdx + 1
        else:
            // Fallback: 선형 할당
            sentEnd = words[wordIdx + len(sentWords) - 1].end
            wordIdx += len(sentWords)

        sentences.append(Sentence(sentText, sentStart, sentEnd))
        prevEndIdx = endIdx

    return sentences

function expandHyphenated(words):
    // "mind-blowing" → ["mind", "blowing"]
    result = []
    for word in words:
        clean = removePunctuation(word.lower())
        if '-' in clean:
            result.extend(clean.split('-'))
        else:
            result.append(clean)
    return result

function findSequence(pattern, startIdx, words):
    // words 배열에서 pattern 시퀀스를 찾아 마지막 인덱스 반환
    for i in range(startIdx, len(words) - len(pattern) + 1):
        match = true
        for j, p in enumerate(pattern):
            if normalize(words[i+j].word) != p:
                match = false
                break
        if match:
            return i + len(pattern) - 1
    return null
```

### 8.4 최소 길이 병합

```
function mergeShortChunks(sentences, minChunkMs):
    result = []
    buffer = null

    for sentence in sentences:
        if buffer == null:
            buffer = sentence
        else:
            buffer = merge(buffer, sentence)

        if buffer.duration >= minChunkMs:
            result.append(buffer)
            buffer = null

    // 마지막 buffer 처리
    if buffer != null:
        if result.isEmpty():
            result.append(buffer)
        else:
            result[-1] = merge(result[-1], buffer)

    return result

function merge(a, b):
    return Sentence(
        text = a.text + " " + b.text,
        start = a.start,
        end = b.end
    )
```

### 8.5 청크 경계 중복 제거

25MB 초과 오디오는 청크로 분할하여 전사하므로, 경계에서 중복이 발생할 수 있습니다.

```
function removeDuplicateWords(words):
    // 타임스탬프 순 정렬
    sorted = sort(words, by: (start, end))

    result = [sorted[0]]
    for word in sorted[1:]:
        prev = result[-1]
        // 타임스탬프 겹치고 같은 단어면 스킵
        if word.start < prev.end and word.word.lower() == prev.word.lower():
            continue
        result.append(word)

    return result
```

---

## 9. 녹음 명세

### 9.1 녹음 설정

| 항목 | 값 |
|------|-----|
| 형식 | AAC (MPEG-4) |
| 비트레이트 | 64 kbps |
| 샘플레이트 | 22050 Hz |
| 채널 | Mono |

### 9.2 파일 경로

```
{app_internal_dir}/recordings/{sourceId}/chunk_{chunkIndex}.m4a
```

### 9.3 저장 규칙

- chunk당 1개 파일만 저장
- 새 녹음 시 기존 파일 삭제 후 덮어쓰기
- 콘텐츠 삭제 시 해당 녹음 폴더 전체 삭제

### 9.4 녹음 재생 우선순위

| 상황 | 동작 |
|------|------|
| PLAY 중 🔊 탭 | 원문 일시정지 → 녹음 재생 → 원문 재개 |
| GAP 중 🔊 탭 | GAP 타이머 일시정지 → 녹음 재생 → GAP 재개 |
| IDLE 중 🔊 탭 | 바로 녹음 재생 |
| HARD 모드 PLAYBACK_REC | 자동으로 현재 chunk 녹음 재생 |

---

## 10. 캐시 정책

### 10.1 오디오 캐시

| 항목 | 값 |
|------|-----|
| 최대 용량 | 1GB |
| 초과 시 | LRU 방식으로 오래된 것부터 삭제 |
| 저장 위치 | Media3 Cache 디렉토리 |

### 10.2 Source ID 규칙

| 타입 | ID 생성 방식 |
|------|-------------|
| 팟캐스트 에피소드 | `guid` 또는 `audioUrl` SHA-256 해시 |
| 로컬 파일 | 파일 바이트 SHA-256 해시 |

### 10.3 재전사 조건

- 동일 sourceId + 동일 language → 재전사 금지 (기존 결과 재사용)
- 동일 sourceId + 다른 language → 별도 전사 결과 저장

---

## 11. 화면 전환 흐름

```
┌───────────────────────────────────────────────────────────────┐
│                                                               │
│   홈 ◄─► 플레이리스트 ◄─► 팟캐스트 ◄─► 미디어파일 ◄─► 설정   │
│    │         │              │            │                    │
│    └─────────┴──────────────┴────────────┘                    │
│                      │                                        │
│                      ▼                                        │
│              콘텐츠 선택                                       │
│                      │                                        │
│          ┌──────────┴──────────┐                             │
│          ▼                     ▼                             │
│      캐시 있음            캐시 없음                           │
│          │                     │                             │
│          │                     ▼                             │
│          │              전사 진행 화면                        │
│          │                     │                             │
│          └─────────┬───────────┘                             │
│                    ▼                                          │
│           전체 화면 플레이어                                   │
│                    │                                          │
│                    │ 아래 스와이프 (헤더)                      │
│                    ▼                                          │
│            미니 플레이어                                       │
│          (탭 화면과 공존)                                      │
│                    │                                          │
│                    │ 위로 스와이프 / 탭                        │
│                    ▼                                          │
│           전체 화면 플레이어                                   │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

---

## 12. 프로젝트 구조 (예정)

```
app/
├── src/main/java/com/listener/
│   ├── App.kt
│   ├── MainActivity.kt
│   │
│   ├── data/
│   │   ├── local/
│   │   │   ├── db/
│   │   │   │   ├── ListenerDatabase.kt
│   │   │   │   ├── dao/
│   │   │   │   └── entity/
│   │   │   ├── cache/
│   │   │   └── preferences/
│   │   ├── remote/
│   │   │   ├── api/
│   │   │   │   ├── ITunesApi.kt
│   │   │   │   └── OpenAiApi.kt
│   │   │   └── dto/
│   │   └── repository/
│   │
│   ├── domain/
│   │   ├── model/
│   │   ├── repository/
│   │   └── usecase/
│   │
│   ├── presentation/
│   │   ├── navigation/
│   │   ├── home/
│   │   ├── playlist/
│   │   ├── podcast/
│   │   ├── media/
│   │   ├── settings/
│   │   ├── transcription/
│   │   ├── player/
│   │   │   ├── MiniPlayer.kt
│   │   │   ├── FullScreenPlayer.kt
│   │   │   └── PlayerViewModel.kt
│   │   └── components/
│   │
│   ├── service/
│   │   ├── PlaybackService.kt
│   │   └── TranscriptionService.kt
│   │
│   └── core/
│       ├── di/
│       ├── util/
│       └── extension/
│
├── src/main/res/
└── build.gradle.kts
```

---

## 13. 검증 체크리스트

### 13.1 기능 검증

- [ ] 팟캐스트 검색 및 구독
- [ ] 에피소드 목록 및 RSS 파싱
- [ ] 로컬 파일 추가
- [ ] 오디오 다운로드 및 캐싱
- [ ] OpenAI 전사 API 호출
- [ ] chunk 분절 (문장부호 + minChunkMs)
- [ ] 일반 모드 학습 재생
- [ ] HARD 모드 학습 재생
- [ ] 녹음 및 재생
- [ ] 플레이리스트 생성/편집
- [ ] 미니 플레이어 ↔ 전체 화면 전환
- [ ] 백그라운드 재생
- [ ] 설정 저장 및 적용

### 13.2 UX 검증

- [ ] 전사문 스크롤 및 chunk 이동 제스처
- [ ] 가림 모드 동작
- [ ] 녹음 듣기 버튼 표시/숨김
- [ ] 플레이리스트 순서 변경 (드래그)
- [ ] 빈 상태 화면 표시
